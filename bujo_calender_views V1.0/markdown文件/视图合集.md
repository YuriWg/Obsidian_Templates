---
created: 2025-02-28T09:16:00
updated: 2025-03-01T13:14
---
### æ—¥è§†å›¾
```dataviewjs
// è·å–å½“å‰é¡µé¢çš„æ—¥æœŸï¼ˆæ”¯æŒæ–‡ä»¶åå’Œcreatedå±æ€§ï¼‰
const getPageDate = () => {
  // å°è¯•ä»æ–‡ä»¶åè·å–æ—¥æœŸ
  const fileName = dv.current().file.name.split(" ")[0];
  const dateMatch = fileName.match(/^\d{4}-\d{2}-\d{2}$/);
  
  if (dateMatch) {
    const [year, month, day] = fileName.split("-").map(Number);
    return new Date(year, month - 1, day);
  }
  
  // å¦‚æœæ–‡ä»¶åä¸æ˜¯æ—¥æœŸæ ¼å¼ï¼Œä½¿ç”¨createdå±æ€§
  return new Date(dv.current().created);
};

const currentDate = getPageDate();
const [year, month, day] = [
  currentDate.getFullYear(),
  currentDate.getMonth() + 1,
  currentDate.getDate()
];

// è®¡ç®—æœ¬å‘¨æ—¥æœŸ
const currentDayOfWeek = (currentDate.getDay() + 6) % 7;
const weekStart = new Date(currentDate);
weekStart.setDate(currentDate.getDate() - currentDayOfWeek);
const weekEnd = new Date(currentDate);
weekEnd.setDate(currentDate.getDate() + (6 - currentDayOfWeek));

// ä¿®æ”¹æ—¥æœŸæ ¼å¼åŒ–å‡½æ•°
const formatDateStr = (date) => {
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const d = String(date.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
};

// ç®€åŒ–å‘¨æ•°è®¡ç®—
const getWeekInfo = (date) => {
  const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
  const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
  return {
    week: 2 + Math.floor((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7),
    year: date.getFullYear()
  };
};

// è·å– ISO å‘¨æ•°
const getISOWeek = (date) => {
    const target = new Date(date.valueOf());
    const dayNr = (date.getDay() + 6) % 7;
    target.setDate(target.getDate() - dayNr + 3);
    const jan4 = new Date(target.getFullYear(), 0, 4);
    const dayDiff = (target - jan4) / 86400000;
    return 2 + Math.floor(dayDiff / 7);
};

// æ ¼å¼åŒ–æ ‡é¢˜
const weekNumber = getISOWeek(currentDate);
const formattedWeek = `${year} W${weekNumber}`;

// ä¿®æ”¹å®¹å™¨ç±»å
let calendarHTML = `<div class="calendar-container">`;
calendarHTML += `<div class="calendar-week-title">${formattedWeek}</div>`;
calendarHTML += `<div class="calendar-divider"></div>`;
calendarHTML += `<div class="calendar-grid">`;

// æ·»åŠ æ˜ŸæœŸæ ‡é¢˜
["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"].forEach(day => {
    calendarHTML += `<div class="weekday-header">${day}</div>`;
});

// å¡«å……æ—¥æœŸ
for (let i = 0; i < 7; i++) {
    const date = new Date(weekStart);
    date.setDate(weekStart.getDate() + i);
    const dateStr = formatDateStr(date);
    const page = dv.page(dateStr);

    let cellClasses = ["date-cell"];
    if (date.toDateString() === currentDate.toDateString()) {
        cellClasses.push("date-cell-current");
    } else if (page) {
        cellClasses.push("date-cell-has-note");
    }

    calendarHTML += `<div class="${cellClasses.join(' ')}">${date.getDate()}</div>`;
}

calendarHTML += `</div>`; // ç»“æŸ calendar-grid

// å°†å¼•ç”¨åŒºå—ç§»åˆ°æ—¥å†ç½‘æ ¼å¤–éƒ¨
//calendarHTML += `<div class="calendar-divider"></div>`;
calendarHTML += `<div class="quote-container" style="grid-column: 1 / -1; margin-top: 10px; text-align: left;">
    <div class="quote-icon">â</div>
    ${dv.current().quote ? 
        String(dv.current().quote)
            .replace(/^"+|"+$/g, '')
            .replace(/(\[\[.*?\]\])|(.*\.md\|?)/g, (match) => {
                const parts = match.split('|');
                return parts.length > 1 ? parts.pop() : parts[0];
            })
            .replace(/\]\]/g, '') :
        '<span style="opacity:1;">æµŠæ°´å˜æ¾„æ¸…ï¼Œå…¨åœ¨è‡ªæµä¸­ã€‚â€”â€”â€”â€”ç§ç”°å±±å¤´ç«</span>'}
</div>`;

calendarHTML += `</div>`; // ç»“æŸ calendar-container

dv.paragraph(calendarHTML);

```

### å‘¨è§†å›¾
```dataviewjs
// æ—¥æœŸç›¸å…³å‡½æ•°
function formatDate(date) {
  return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
}

function getWeekRange(baseDate) {
  const dayOfWeek = (baseDate.getDay() + 6) % 7;
  const startDate = new Date(baseDate);
  startDate.setDate(baseDate.getDate() - dayOfWeek);
  const endDate = new Date(startDate);
  endDate.setDate(startDate.getDate() + 6);
  return { startDate, endDate };
}

// ä¼˜åŒ–æ—¥æœŸå¤„ç†å‡½æ•°
function getDateInfo(date) {
  return {
    year: date.getFullYear(),
    month: date.getMonth(),
    day: date.getDate(),
    weekday: (date.getDay() + 6) % 7
  };
}

// ç®€åŒ–é¡µé¢æŸ¥è¯¢é€»è¾‘
function getPageForDate(dateStr) {
  return dv.pages('"0_Bullet Journal/Daily Notes"')
    .where(p => p.file.name.startsWith(dateStr))
    .first();
}

// ä¿®æ”¹å®¹å™¨ç±»åï¼Œä½¿ç”¨å…±äº«æ ·å¼
let combinedHTML = '<div class="week-view-container calendar-container">';

try {
  const baseDate = dv.current().created ? new Date(dv.current().created) : new Date();
  const { startDate, endDate } = getWeekRange(baseDate);
  const currentYear = startDate.getFullYear();
  const currentMonth = startDate.getMonth();
  const currentWeek = Math.ceil((baseDate - new Date(baseDate.getFullYear(), 0, 1)) / (1000 * 60 * 60 * 24 * 7));

  // ç”Ÿæˆæœˆå†HTML
  combinedHTML += `
    <div class="month-calendar">
      <div class="month-calendar-title">
        ${currentYear} ${["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"][currentMonth]} W${currentWeek}
      </div>
      <div class="calendar-grid">
        ${generateWeekGrid(startDate, endDate)}
      </div>
    </div>
  `;

  // ç”Ÿæˆä¹ æƒ¯è·Ÿè¸ªå™¨HTML
  combinedHTML += `
    <div class="habit-section">
      ${generateHabitTracker(startDate, endDate)}
    </div>
  `;

} catch (e) {
  console.error("Error in week view:", e);
  combinedHTML += '<div class="error-message">Error generating week view</div>';
}

combinedHTML += '</div>';
dv.paragraph(combinedHTML);

// è¾…åŠ©å‡½æ•°
function generateWeekGrid(startDate, endDate) {
  const dateInfo = getDateInfo(startDate);
  let gridHTML = '';
  
  // æ·»åŠ æ˜ŸæœŸæ ‡é¢˜
  ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"].forEach(day => {
    gridHTML += `<div class="weekday-header">${day}</div>`;
  });
  
  // é‡ç½®æ—¶é—´éƒ¨åˆ†ï¼Œåªæ¯”è¾ƒæ—¥æœŸ
  startDate.setHours(0, 0, 0, 0);
  endDate.setHours(0, 0, 0, 0);
  
  // è·å–å½“å‰æœˆçš„ä¿¡æ¯
  const currentYear = startDate.getFullYear();
  const currentMonth = startDate.getMonth();
  const firstDay = new Date(currentYear, currentMonth, 1);
  const lastDay = new Date(currentYear, currentMonth + 1, 0);
  const firstDayWeek = (firstDay.getDay() + 6) % 7;
  const prevMonthDays = new Date(currentYear, currentMonth, 0).getDate();
  
  // æ·»åŠ ä¸Šæœˆæœ«å°¾æ—¥æœŸ
  for (let i = 0; i < firstDayWeek; i++) {
    const date = new Date(currentYear, currentMonth - 1, prevMonthDays - firstDayWeek + i + 1);
    const isCurrentWeek = date >= startDate && date <= endDate;
    
    gridHTML += `
      <div class="date-cell${isCurrentWeek ? ' date-cell-empty' : ' date-cell-other'}">
        ${prevMonthDays - firstDayWeek + i + 1}
      </div>`;
  }

  // æ·»åŠ æœ¬æœˆæ—¥æœŸ
  for (let i = 1; i <= lastDay.getDate(); i++) {
    const currentDate = new Date(currentYear, currentMonth, i);
    currentDate.setHours(0, 0, 0, 0);
    const dateStr = formatDate(currentDate);
    const weekDay = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][currentDate.getDay()];
    // ä¿®æ”¹ï¼šæŸ¥æ‰¾æ–¹å¼æ”¹ä¸ºç²¾ç¡®åŒ¹é…æ—¥æœŸå‰ç¼€
    const pages = dv.pages()
      .where(p => p.file.name.startsWith(dateStr))
      .values;
    const page = pages.length > 0;
    
    const isCurrentWeek = currentDate >= startDate && currentDate <= endDate;
    
    gridHTML += `
      <div class="date-cell${isCurrentWeek ? (page ? ' date-cell-current' : ' date-cell-empty') : ''}">
        ${i}
      </div>`;
  }

  // æ·»åŠ ä¸‹æœˆå¼€å§‹æ—¥æœŸ
  const lastDayWeek = (lastDay.getDay() + 6) % 7;
  for (let i = 1; i <= 6 - lastDayWeek; i++) {
    const nextDate = new Date(currentYear, currentMonth + 1, i);
    nextDate.setHours(0, 0, 0, 0);
    const dateStr = formatDate(nextDate);
    // ä¿®æ”¹ï¼šå¯¹ä¸‹æœˆæ—¥æœŸä¹Ÿä½¿ç”¨ç›¸åŒçš„æŸ¥æ‰¾é€»è¾‘
    const pages = dv.pages()
      .where(p => p.file.name.startsWith(dateStr))
      .values;
    const page = pages.length > 0;
    
    const isCurrentWeek = nextDate >= startDate && nextDate <= endDate;
    
    gridHTML += `
      <div class="date-cell${isCurrentWeek ? (page ? ' date-cell-current' : ' date-cell-empty') : ' date-cell-other'}">
        ${i}
      </div>`;
  }
  
  return gridHTML;
}

function generateHabitTracker(startDate, endDate) {
  const habits = ['ğŸ§˜ æ‹‰ä¼¸', 'ğŸ““ æ—¥è®°', 'ğŸ’» ç¬”è®°', 'ğŸƒ æ…¢è·‘', 'ğŸ“– é˜…è¯»', 'ğŸ¤” Stoic', 'ğŸ’¢ å¿ƒæƒ…'];
  const moodEmojiMap = {
    '-5': 'ğŸ˜±', '-4': 'ğŸ˜–', '-3': 'ğŸ˜Ÿ', '-2': 'ğŸ˜”', '-1': 'ğŸ˜•',
    '0': 'ğŸ˜', '1': 'ğŸ™‚', '2': 'ğŸ˜Š', '3': 'ğŸ˜„', '4': 'ğŸ¥°', '5': 'ğŸ˜‡'
  };
  
  let trackerHTML = `<div class="habit-tracker">
    <div class="habit-grid">
      <div class="habit-header"></div>
      ${["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"].map(day => 
        `<div class="habit-day-name">${day}</div>`
      ).join('')}`;
  
  habits.forEach(habit => {
    trackerHTML += `<div class="habit-name">${habit}</div>`;
    
    for (let i = 0; i < 7; i++) {
      const currentDate = new Date(startDate);
      currentDate.setDate(startDate.getDate() + i);
      const dateStr = formatDate(currentDate);
      const page = getPageForDate(dateStr);
      
      const status = page ? {
        'ğŸ§˜ æ‹‰ä¼¸': page.stretch || false,
        'ğŸ““ æ—¥è®°': page.journal || false,
        'ğŸ’» ç¬”è®°': page.notes || false,
        'ğŸƒ æ…¢è·‘': page.running || false,
        'ğŸ“– é˜…è¯»': page.reading || false,
        'ğŸ¤” Stoic': page.stoic || "",
        'ğŸ’¢ å¿ƒæƒ…': page.mood ?? null
      }[habit] : null;
      
      const isMood = habit === 'ğŸ’¢ å¿ƒæƒ…';
      
      trackerHTML += `
        <div class="habit-status ${status ? 'habit-status-done' : 'habit-status-empty'} ${isMood ? 'habit-status-mood' : ''}">
          <span style="
            color: ${isMood ? 'var(--interactive-accent)' : 'white'};
            font-size: ${isMood ? '1.2em' : '1em'};
          ">
            ${isMood ? (status !== null ? moodEmojiMap[status] : '') : (status ? 'âœ“' : '')}
          </span>
        </div>`;
    }
  });
  
  trackerHTML += '</div>';
  return trackerHTML;
  }
```


### æœˆè§†å›¾

```dataviewjs
// ç§»é™¤å†…è”æ ·å¼å®šä¹‰
const mainContainerStyle = ``;
const containerStyle = ``;

// åˆå§‹åŒ–å®¹å™¨
let combinedHTML = '<div class="month-view-container calendar-container">';

// è·å–å½“å‰å¹´ä»½å’Œæœˆä»½
const currentYear = new Date().getFullYear();
const currentMonth = new Date(dv.current().created).getMonth()+1;

// å¹´åº¦æ¦‚è§ˆéƒ¨åˆ†
let yearCalendarHTML = `
  <div class="year-overview">
    <div class="year-title">
      ${currentYear}
      <span class="year-subtitle">æ­£ç¡®çš„å¼€å§‹ï¼Œå¾®å°çš„é•¿è¿›ï¼Œç„¶åæŒç»­ã€‚</span>
    </div>
    <div class="months-container">`;

// ç”Ÿæˆæœˆä»½æŒ‰é’®
for (let month = 1; month <= 12; month++) {
  const monthStart = dv.date(`${currentYear}-${String(month).padStart(2,'0')}-01`);
  const monthName = monthStart.toFormat('MMM');
  const hasMonthlyNote = dv.page(`Monthly/${currentYear}-${String(month).padStart(2,'0')}`);
  
  const classes = [
    'month-button',
    month === currentMonth ? 'current' : '',
    hasMonthlyNote ? 'has-note' : ''
  ].filter(Boolean).join(' ');

  yearCalendarHTML += `
    <div class="${classes}"
         onclick="${hasMonthlyNote ? `app.workspace.openLinkText('','${hasMonthlyNote.file.path}')` : ''}">
      ${monthName}
    </div>`;
}

yearCalendarHTML += '</div></div>';

// åˆ›å»ºæ ‡é¢˜å’Œç½‘æ ¼å¸ƒå±€
let habitHTML = `
<div class="habit-grid">  
    <div class="habit-header"></div>
`;
// ç¡®ä¿æ—¥æœŸæ¡†æ¶ç¨³å®šç”Ÿæˆ
const buildCalendarGrid = () => {
  // è·å–å½“å‰æœˆä»½ï¼ˆåŠ¨æ€ï¼‰
  const currentDate =  dv.date(dv.current().created);
  const monthStart = currentDate.startOf('month');
  const daysInMonth = currentDate.daysInMonth;
  
  // æ ¸å¿ƒæ¡†æ¶ç”Ÿæˆ
  let habitHTML = `
  <div style="
    display: grid;
    grid-template-columns: minmax(90px, 1fr) repeat(${daysInMonth}, minmax(1.5rem, 1fr)) minmax(50px, 0.5fr);
    gap: 4px;
    width: 100%;
    max-width: 100%;
    text-align: center;
    padding: 20px;
    background-color: hsla(var(--interactive-accent-hsl), 0.05); 
    border-radius: 5px;
    overflow-x: auto;
    scrollbar-width: thin;
    -webkit-overflow-scrolling: touch;
  ">  
    <div class="habit-header"></div>
  `;

  // ç”Ÿæˆæ—¥æœŸåˆ—ï¼ˆå¼ºåˆ¶ç”Ÿæˆç©ºæ¡†æ¶ï¼‰
  Array.from({length: daysInMonth}).forEach((_, index) => {
	habitHTML += `<div class="habit-day-name">${index +1}</div>`;
  });
  habitHTML += `<div class="habit-day-name"> </div>`; //ç»Ÿè®¡åˆ—

  // å®šä¹‰ä¹ æƒ¯åˆ—è¡¨
  const habits = ['ğŸ§˜ æ‹‰ä¼¸', 'ğŸ““ æ—¥è®°', 'ğŸ’» ç¬”è®°', 'ğŸƒ æ…¢è·‘', 'ğŸ“– é˜…è¯»', 'ğŸ¤” Stoic', 'ğŸ’¢ å¿ƒæƒ…'];

  // è·å–æ•°æ®ï¼ˆå¸¦ç©ºå€¼ä¿æŠ¤ï¼‰
  const safeGetPages = () => {
	try {
	  return dv.pages('"0_Bullet Journal/Daily Notes"')
		.where(p => p?.file?.name?.startsWith(monthStart.toFormat('yyyy-MM')))
		.sort(p => p.file.name, 'asc') || [];
	} catch {
	  return [];
	}
  };
  const pages = safeGetPages();

  const moodEmojiMap = {
    [-5]: 'ğŸ˜±', [-4]: 'ğŸ˜–', [-3]: 'ğŸ˜Ÿ', [-2]: 'ğŸ˜”', [-1]: 'ğŸ˜•',
    0: 'ğŸ˜', 1: 'ğŸ™‚', 2: 'ğŸ˜Š', 3: 'ğŸ˜„', 4: 'ğŸ¥°', 5: 'ğŸ˜‡'
  };

  // ç®€åŒ–ä¹ æƒ¯çŠ¶æ€è·å–é€»è¾‘
  const getHabitState = (page, habit) => {
    const stateMap = {
      'ğŸ§˜ æ‹‰ä¼¸': 'stretch',
      'ğŸ““ æ—¥è®°': 'journal',
      'ğŸ’» ç¬”è®°': 'notes',
      'ğŸƒ æ…¢è·‘': 'running',
      'ğŸ“– é˜…è¯»': 'reading',
      'ğŸ¤” Stoic': 'stoic',
      'ğŸ’¢ å¿ƒæƒ…': 'mood'
    };
    return page?.[stateMap[habit]] ?? null;
  };

  // æ„å»ºä¹ æƒ¯è¡Œ
  habits.forEach(habit => {
	let habitCount = 0;
    let moodSum = 0;
    let moodCount = 0;
	
	habitHTML += `<div class="habit-name">${habit}</div>`;
	
	for (let day = 1; day <= daysInMonth; day++) {
	  const currentDate = monthStart.plus({days: day-1});
	  const page = pages.find(p => 
		dv.date(p?.file?.name?.split(" ")[0])?.toISODate() === currentDate.toISODate()
	  ) || {};

	  // å®‰å…¨è·å–ä¹ æƒ¯çŠ¶æ€
	  const habitState = getHabitState(page, habit);

    // æ›´æ–°ç»Ÿè®¡å€¼éƒ¨åˆ†
    if (habit === 'ğŸ’¢ å¿ƒæƒ…') {
      if (habitState !== null) {
        moodSum += habitState;
        moodCount++;
      }
    } else if (habit === 'ğŸ¤” Stoic') {
      if (page.file && habitState && habitState.trim() !== '') { 
        habitCount++;
      }
    } else {
      if (page.file && habitState === true) { 
        habitCount++;
      }
    }

    // åœ¨æ¸²æŸ“å•å…ƒæ ¼æ—¶ä½¿ç”¨ç®€åŒ–çš„é€»è¾‘
    const getCellStyle = (habit, state) => `
      width: 1.5rem;
      height: 1.5rem;
      background-color: ${habit === 'ğŸ’¢ å¿ƒæƒ…' 
        ? 'var(--background-modifier-hover)'
        : (state ? 'var(--interactive-accent)' : 'var(--background-modifier-hover)')};
      border: 1.5px dotted ${habit === 'ğŸ’¢ å¿ƒæƒ…' 
        ? 'var(--interactive-accent)' 
        : (state ? 'transparent' : 'var(--interactive-accent)')};
    `;

	  // æ¸²æŸ“å•å…ƒæ ¼ï¼ˆå¼ºåˆ¶æœ€å°æ˜¾ç¤ºï¼‰
	  habitHTML += `
	  <div class="habit-status" style="${getCellStyle(habit, habitState)}">
		<span style="
		  color: ${habit === 'ğŸ’¢ å¿ƒæƒ…' ? 'var(--interactive-accent)' : 'white'};
		  opacity: ${page.file ? 1 : 0.5};
      font-size: ${habit === 'ğŸ’¢ å¿ƒæƒ…' ? '1.5rem' : '1rem'}; /* è®¾ç½®è¡¨æƒ…å’Œå­—ç¬¦å¤§å° */
		">
		  ${habit === 'ğŸ’¢ å¿ƒæƒ…' ? (moodEmojiMap[habitState] || '') : (habitState ? 'âœ“' : '')}  
		</span>
	  </div>`;
	}

  const statValue = habit === 'ğŸ’¢ å¿ƒæƒ…' 
    ? moodCount > 0 
      ? moodEmojiMap[Math.round(moodSum / moodCount)] 
      : '-'
    : `${Math.round((habitCount / daysInMonth) * 100)}%`;  // æ‰€æœ‰ä¹ æƒ¯éƒ½ä½¿ç”¨æ•´æœˆå¤©æ•°
    
  habitHTML += `
    <div class="habit-status" style="
      min-width: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-style:  ${habit === 'ğŸ’¢ å¿ƒæƒ…' ? 'normal' : 'normal'};
      color: var(--text-muted);
      background-color: hsla(var(--interactive-accent-hsl), 0);
      border-radius: 4px;
      font-size: ${habit === 'ğŸ’¢ å¿ƒæƒ…' ? '1.5rem' : '1rem'}; /* è®¾ç½®è¡¨æƒ…å’Œå­—ç¬¦å¤§å° */ /* è°ƒæ•´ç»Ÿè®¡åˆ—çš„å­—ä½“å¤§å° */
    ">
      ${statValue}
    </div>
  `;
  });

  return habitHTML + '</div>';
}

// æœ€ç»ˆè¾“å‡º
//dv.paragraph(buildCalendarGrid());
// é—­åˆå®¹å™¨
habitHTML += `</div></div>`;

// ç»„åˆè¾“å‡º
combinedHTML += yearCalendarHTML;
combinedHTML += buildCalendarGrid();
combinedHTML += '</div>';

// æœ€ç»ˆæ¸²æŸ“
dv.paragraph(combinedHTML);
```

