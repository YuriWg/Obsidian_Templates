---
created: 2025-02-28T10:28:00
updated: 2025-03-01T12:47
cssclasses:
  - month-view
  - calendar-views
---
```dataviewjs
// ç§»é™¤å†…è”æ ·å¼å®šä¹‰
const mainContainerStyle = ``;
const containerStyle = ``;

// åˆå§‹åŒ–å®¹å™¨
let combinedHTML = '<div class="month-view-container calendar-container">';

// è·å–å½“å‰å¹´ä»½å’Œæœˆä»½
const currentYear = new Date().getFullYear();
const currentMonth = new Date(dv.current().created).getMonth()+1;

// å¹´åº¦æ¦‚è§ˆéƒ¨åˆ†
let yearCalendarHTML = `
  <div class="year-overview">
    <div class="year-title">
      ${currentYear}
      <span class="year-subtitle">æ­£ç¡®çš„å¼€å§‹ï¼Œå¾®å°çš„é•¿è¿›ï¼Œç„¶åæŒç»­ã€‚</span>
    </div>
    <div class="months-container">`;

// ç”Ÿæˆæœˆä»½æŒ‰é’®
for (let month = 1; month <= 12; month++) {
  const monthStart = dv.date(`${currentYear}-${String(month).padStart(2,'0')}-01`);
  const monthName = monthStart.toFormat('MMM');
  const hasMonthlyNote = dv.page(`Monthly/${currentYear}-${String(month).padStart(2,'0')}`);
  
  const classes = [
    'month-button',
    month === currentMonth ? 'current' : '',
    hasMonthlyNote ? 'has-note' : ''
  ].filter(Boolean).join(' ');

  yearCalendarHTML += `
    <div class="${classes}"
         onclick="${hasMonthlyNote ? `app.workspace.openLinkText('','${hasMonthlyNote.file.path}')` : ''}">
      ${monthName}
    </div>`;
}

yearCalendarHTML += '</div></div>';

// åˆ›å»ºæ ‡é¢˜å’Œç½‘æ ¼å¸ƒå±€
let habitHTML = `
<div class="habit-grid">  
    <div class="habit-header"></div>
`;
// ç¡®ä¿æ—¥æœŸæ¡†æ¶ç¨³å®šç”Ÿæˆ
const buildCalendarGrid = () => {
  // è·å–å½“å‰æœˆä»½ï¼ˆåŠ¨æ€ï¼‰
  const currentDate =  dv.date(dv.current().created);
  const monthStart = currentDate.startOf('month');
  const daysInMonth = currentDate.daysInMonth;
  
  // æ ¸å¿ƒæ¡†æ¶ç”Ÿæˆ
  let habitHTML = `
  <div style="
    display: grid;
    grid-template-columns: minmax(90px, 1fr) repeat(${daysInMonth}, minmax(1.5rem, 1fr)) minmax(50px, 0.5fr);
    gap: 4px;
    width: 100%;
    max-width: 100%;
    text-align: center;
    padding: 20px;
    background-color: hsla(var(--interactive-accent-hsl), 0.05); 
    border-radius: 5px;
    overflow-x: auto;
    scrollbar-width: thin;
    -webkit-overflow-scrolling: touch;
  ">  
    <div class="habit-header"></div>
  `;

  // ç”Ÿæˆæ—¥æœŸåˆ—ï¼ˆå¼ºåˆ¶ç”Ÿæˆç©ºæ¡†æ¶ï¼‰
  Array.from({length: daysInMonth}).forEach((_, index) => {
	habitHTML += `<div class="habit-day-name">${index +1}</div>`;
  });
  habitHTML += `<div class="habit-day-name"> </div>`; //ç»Ÿè®¡åˆ—

  // å®šä¹‰ä¹ æƒ¯åˆ—è¡¨
  const habits = ['ğŸ§˜ æ‹‰ä¼¸', 'ğŸ““ æ—¥è®°', 'ğŸ’» ç¬”è®°', 'ğŸƒ æ…¢è·‘', 'ğŸ“– é˜…è¯»', 'ğŸ¤” Stoic', 'ğŸ’¢ å¿ƒæƒ…'];

  // è·å–æ•°æ®ï¼ˆå¸¦ç©ºå€¼ä¿æŠ¤ï¼‰
  const safeGetPages = () => {
	try {
	  return dv.pages('"0_Bullet Journal/Daily Notes"')
		.where(p => p?.file?.name?.startsWith(monthStart.toFormat('yyyy-MM')))
		.sort(p => p.file.name, 'asc') || [];
	} catch {
	  return [];
	}
  };
  const pages = safeGetPages();

  const moodEmojiMap = {
    [-5]: 'ğŸ˜±', [-4]: 'ğŸ˜–', [-3]: 'ğŸ˜Ÿ', [-2]: 'ğŸ˜”', [-1]: 'ğŸ˜•',
    0: 'ğŸ˜', 1: 'ğŸ™‚', 2: 'ğŸ˜Š', 3: 'ğŸ˜„', 4: 'ğŸ¥°', 5: 'ğŸ˜‡'
  };

  // ç®€åŒ–ä¹ æƒ¯çŠ¶æ€è·å–é€»è¾‘
  const getHabitState = (page, habit) => {
    const stateMap = {
      'ğŸ§˜ æ‹‰ä¼¸': 'stretch',
      'ğŸ““ æ—¥è®°': 'journal',
      'ğŸ’» ç¬”è®°': 'notes',
      'ğŸƒ æ…¢è·‘': 'running',
      'ğŸ“– é˜…è¯»': 'reading',
      'ğŸ¤” Stoic': 'stoic',
      'ğŸ’¢ å¿ƒæƒ…': 'mood'
    };
    return page?.[stateMap[habit]] ?? null;
  };

  // æ„å»ºä¹ æƒ¯è¡Œ
  habits.forEach(habit => {
	let habitCount = 0;
    let moodSum = 0;
    let moodCount = 0;
	
	habitHTML += `<div class="habit-name">${habit}</div>`;
	
	for (let day = 1; day <= daysInMonth; day++) {
	  const currentDate = monthStart.plus({days: day-1});
	  const page = pages.find(p => 
		dv.date(p?.file?.name?.split(" ")[0])?.toISODate() === currentDate.toISODate()
	  ) || {};

	  // å®‰å…¨è·å–ä¹ æƒ¯çŠ¶æ€
	  const habitState = getHabitState(page, habit);

    // æ›´æ–°ç»Ÿè®¡å€¼éƒ¨åˆ†
    if (habit === 'ğŸ’¢ å¿ƒæƒ…') {
      if (habitState !== null) {
        moodSum += habitState;
        moodCount++;
      }
    } else if (habit === 'ğŸ¤” Stoic') {
      if (page.file && habitState && habitState.trim() !== '') { 
        habitCount++;
      }
    } else {
      if (page.file && habitState === true) { 
        habitCount++;
      }
    }

    // åœ¨æ¸²æŸ“å•å…ƒæ ¼æ—¶ä½¿ç”¨ç®€åŒ–çš„é€»è¾‘
    const getCellStyle = (habit, state) => `
      width: 1.5rem;
      height: 1.5rem;
      background-color: ${habit === 'ğŸ’¢ å¿ƒæƒ…' 
        ? 'var(--background-modifier-hover)'
        : (state ? 'var(--interactive-accent)' : 'var(--background-modifier-hover)')};
      border: 1.5px dotted ${habit === 'ğŸ’¢ å¿ƒæƒ…' 
        ? 'var(--interactive-accent)' 
        : (state ? 'transparent' : 'var(--interactive-accent)')};
    `;

	  // æ¸²æŸ“å•å…ƒæ ¼ï¼ˆå¼ºåˆ¶æœ€å°æ˜¾ç¤ºï¼‰
	  habitHTML += `
	  <div class="habit-status" style="${getCellStyle(habit, habitState)}">
		<span style="
		  color: ${habit === 'ğŸ’¢ å¿ƒæƒ…' ? 'var(--interactive-accent)' : 'white'};
		  opacity: ${page.file ? 1 : 0.5};
      font-size: ${habit === 'ğŸ’¢ å¿ƒæƒ…' ? '1.5rem' : '1rem'}; /* è®¾ç½®è¡¨æƒ…å’Œå­—ç¬¦å¤§å° */
		">
		  ${habit === 'ğŸ’¢ å¿ƒæƒ…' ? (moodEmojiMap[habitState] || '') : (habitState ? 'âœ“' : '')}  
		</span>
	  </div>`;
	}

  const statValue = habit === 'ğŸ’¢ å¿ƒæƒ…' 
    ? moodCount > 0 
      ? moodEmojiMap[Math.round(moodSum / moodCount)] 
      : '-'
    : `${Math.round((habitCount / daysInMonth) * 100)}%`;  // æ‰€æœ‰ä¹ æƒ¯éƒ½ä½¿ç”¨æ•´æœˆå¤©æ•°
    
  habitHTML += `
    <div class="habit-status" style="
      min-width: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-style:  ${habit === 'ğŸ’¢ å¿ƒæƒ…' ? 'normal' : 'normal'};
      color: var(--text-muted);
      background-color: hsla(var(--interactive-accent-hsl), 0);
      border-radius: 4px;
      font-size: ${habit === 'ğŸ’¢ å¿ƒæƒ…' ? '1.5rem' : '1rem'}; /* è®¾ç½®è¡¨æƒ…å’Œå­—ç¬¦å¤§å° */ /* è°ƒæ•´ç»Ÿè®¡åˆ—çš„å­—ä½“å¤§å° */
    ">
      ${statValue}
    </div>
  `;
  });

  return habitHTML + '</div>';
}

// æœ€ç»ˆè¾“å‡º
//dv.paragraph(buildCalendarGrid());
// é—­åˆå®¹å™¨
habitHTML += `</div></div>`;

// ç»„åˆè¾“å‡º
combinedHTML += yearCalendarHTML;
combinedHTML += buildCalendarGrid();
combinedHTML += '</div>';

// æœ€ç»ˆæ¸²æŸ“
dv.paragraph(combinedHTML);
```