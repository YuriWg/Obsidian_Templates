---
created: 2025-03-01T10:25:00
updated: 2025-03-01T13:11
cssclasses:
  - week-view
  - calendar-views
---
```dataviewjs
// æ—¥æœŸç›¸å…³å‡½æ•°
function formatDate(date) {
  return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
}

function getWeekRange(baseDate) {
  const dayOfWeek = (baseDate.getDay() + 6) % 7;
  const startDate = new Date(baseDate);
  startDate.setDate(baseDate.getDate() - dayOfWeek);
  const endDate = new Date(startDate);
  endDate.setDate(startDate.getDate() + 6);
  return { startDate, endDate };
}

// ä¼˜åŒ–æ—¥æœŸå¤„ç†å‡½æ•°
function getDateInfo(date) {
  return {
    year: date.getFullYear(),
    month: date.getMonth(),
    day: date.getDate(),
    weekday: (date.getDay() + 6) % 7
  };
}

// ç®€åŒ–é¡µé¢æŸ¥è¯¢é€»è¾‘
function getPageForDate(dateStr) {
  return dv.pages('"0_Bullet Journal/Daily Notes"')
    .where(p => p.file.name.startsWith(dateStr))
    .first();
}

// ä¿®æ”¹å®¹å™¨ç±»åï¼Œä½¿ç”¨å…±äº«æ ·å¼
let combinedHTML = '<div class="week-view-container calendar-container">';

try {
  const baseDate = dv.current().created ? new Date(dv.current().created) : new Date();
  const { startDate, endDate } = getWeekRange(baseDate);
  const currentYear = startDate.getFullYear();
  const currentMonth = startDate.getMonth();
  const currentWeek = Math.ceil((baseDate - new Date(baseDate.getFullYear(), 0, 1)) / (1000 * 60 * 60 * 24 * 7));

  // ç”Ÿæˆæœˆå†HTML
  combinedHTML += `
    <div class="month-calendar">
      <div class="month-calendar-title">
        ${currentYear} ${["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"][currentMonth]} W${currentWeek}
      </div>
      <div class="calendar-grid">
        ${generateWeekGrid(startDate, endDate)}
      </div>
    </div>
  `;

  // ç”Ÿæˆä¹ æƒ¯è·Ÿè¸ªå™¨HTML
  combinedHTML += `
    <div class="habit-section">
      ${generateHabitTracker(startDate, endDate)}
    </div>
  `;

} catch (e) {
  console.error("Error in week view:", e);
  combinedHTML += '<div class="error-message">Error generating week view</div>';
}

combinedHTML += '</div>';
dv.paragraph(combinedHTML);

// è¾…åŠ©å‡½æ•°
function generateWeekGrid(startDate, endDate) {
  const dateInfo = getDateInfo(startDate);
  let gridHTML = '';
  
  // æ·»åŠ æ˜ŸæœŸæ ‡é¢˜
  ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"].forEach(day => {
    gridHTML += `<div class="weekday-header">${day}</div>`;
  });
  
  // é‡ç½®æ—¶é—´éƒ¨åˆ†ï¼Œåªæ¯”è¾ƒæ—¥æœŸ
  startDate.setHours(0, 0, 0, 0);
  endDate.setHours(0, 0, 0, 0);
  
  // è·å–å½“å‰æœˆçš„ä¿¡æ¯
  const currentYear = startDate.getFullYear();
  const currentMonth = startDate.getMonth();
  const firstDay = new Date(currentYear, currentMonth, 1);
  const lastDay = new Date(currentYear, currentMonth + 1, 0);
  const firstDayWeek = (firstDay.getDay() + 6) % 7;
  const prevMonthDays = new Date(currentYear, currentMonth, 0).getDate();
  
  // æ·»åŠ ä¸Šæœˆæœ«å°¾æ—¥æœŸ
  for (let i = 0; i < firstDayWeek; i++) {
    const date = new Date(currentYear, currentMonth - 1, prevMonthDays - firstDayWeek + i + 1);
    const isCurrentWeek = date >= startDate && date <= endDate;
    
    gridHTML += `
      <div class="date-cell${isCurrentWeek ? ' date-cell-empty' : ' date-cell-other'}">
        ${prevMonthDays - firstDayWeek + i + 1}
      </div>`;
  }

  // æ·»åŠ æœ¬æœˆæ—¥æœŸ
  for (let i = 1; i <= lastDay.getDate(); i++) {
    const currentDate = new Date(currentYear, currentMonth, i);
    currentDate.setHours(0, 0, 0, 0);
    const dateStr = formatDate(currentDate);
    const weekDay = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][currentDate.getDay()];
    // ä¿®æ”¹ï¼šæŸ¥æ‰¾æ–¹å¼æ”¹ä¸ºç²¾ç¡®åŒ¹é…æ—¥æœŸå‰ç¼€
    const pages = dv.pages()
      .where(p => p.file.name.startsWith(dateStr))
      .values;
    const page = pages.length > 0;
    
    const isCurrentWeek = currentDate >= startDate && currentDate <= endDate;
    
    gridHTML += `
      <div class="date-cell${isCurrentWeek ? (page ? ' date-cell-current' : ' date-cell-empty') : ''}">
        ${i}
      </div>`;
  }

  // æ·»åŠ ä¸‹æœˆå¼€å§‹æ—¥æœŸ
  const lastDayWeek = (lastDay.getDay() + 6) % 7;
  for (let i = 1; i <= 6 - lastDayWeek; i++) {
    const nextDate = new Date(currentYear, currentMonth + 1, i);
    nextDate.setHours(0, 0, 0, 0);
    const dateStr = formatDate(nextDate);
    // ä¿®æ”¹ï¼šå¯¹ä¸‹æœˆæ—¥æœŸä¹Ÿä½¿ç”¨ç›¸åŒçš„æŸ¥æ‰¾é€»è¾‘
    const pages = dv.pages()
      .where(p => p.file.name.startsWith(dateStr))
      .values;
    const page = pages.length > 0;
    
    const isCurrentWeek = nextDate >= startDate && nextDate <= endDate;
    
    gridHTML += `
      <div class="date-cell${isCurrentWeek ? (page ? ' date-cell-current' : ' date-cell-empty') : ' date-cell-other'}">
        ${i}
      </div>`;
  }
  
  return gridHTML;
}

function generateHabitTracker(startDate, endDate) {
  const habits = ['ğŸ§˜ æ‹‰ä¼¸', 'ğŸ““ æ—¥è®°', 'ğŸ’» ç¬”è®°', 'ğŸƒ æ…¢è·‘', 'ğŸ“– é˜…è¯»', 'ğŸ¤” Stoic', 'ğŸ’¢ å¿ƒæƒ…'];
  const moodEmojiMap = {
    '-5': 'ğŸ˜±', '-4': 'ğŸ˜–', '-3': 'ğŸ˜Ÿ', '-2': 'ğŸ˜”', '-1': 'ğŸ˜•',
    '0': 'ğŸ˜', '1': 'ğŸ™‚', '2': 'ğŸ˜Š', '3': 'ğŸ˜„', '4': 'ğŸ¥°', '5': 'ğŸ˜‡'
  };
  
  let trackerHTML = `<div class="habit-tracker">
    <div class="habit-grid">
      <div class="habit-header"></div>
      ${["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"].map(day => 
        `<div class="habit-day-name">${day}</div>`
      ).join('')}`;
  
  habits.forEach(habit => {
    trackerHTML += `<div class="habit-name">${habit}</div>`;
    
    for (let i = 0; i < 7; i++) {
      const currentDate = new Date(startDate);
      currentDate.setDate(startDate.getDate() + i);
      const dateStr = formatDate(currentDate);
      const page = getPageForDate(dateStr);
      
      const status = page ? {
        'ğŸ§˜ æ‹‰ä¼¸': page.stretch || false,
        'ğŸ““ æ—¥è®°': page.journal || false,
        'ğŸ’» ç¬”è®°': page.notes || false,
        'ğŸƒ æ…¢è·‘': page.running || false,
        'ğŸ“– é˜…è¯»': page.reading || false,
        'ğŸ¤” Stoic': page.stoic || "",
        'ğŸ’¢ å¿ƒæƒ…': page.mood ?? null
      }[habit] : null;
      
      const isMood = habit === 'ğŸ’¢ å¿ƒæƒ…';
      
      trackerHTML += `
        <div class="habit-status ${status ? 'habit-status-done' : 'habit-status-empty'} ${isMood ? 'habit-status-mood' : ''}">
          <span style="
            color: ${isMood ? 'var(--interactive-accent)' : 'white'};
            font-size: ${isMood ? '1.2em' : '1em'};
          ">
            ${isMood ? (status !== null ? moodEmojiMap[status] : '') : (status ? 'âœ“' : '')}
          </span>
        </div>`;
    }
  });
  
  trackerHTML += '</div>';
  return trackerHTML;
}